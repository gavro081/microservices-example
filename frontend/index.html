<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Frontend Client</title>
		<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	</head>
	<body>
		<div>
			<form class="w-80 ml-4 mt-4" id="orderForm">
				<div>
					<label for="username" class="block text-sm font-medium text-gray-700"
						>Username</label
					>
					<input
						type="text"
						id="username"
						name="username"
						class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border border-solid"
						required
					/>
				</div>
				<div>
					<label for="product" class="block text-sm font-medium text-gray-700"
						>Product Name</label
					>
					<input
						type="text"
						id="product"
						name="product"
						class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border border-solid"
						required
					/>
				</div>
				<div>
					<label for="quantity" class="block text-sm font-medium text-gray-700"
						>Quantity</label
					>
					<input
						type="number"
						id="quantity"
						name="quantity"
						class="mt-1 block w-full border-gray-300 rounded-md shadow-sm border border-solid"
						required
						min="1"
					/>
				</div>
				<button
					id="submitBtn"
					class="bg-gray-300 p-2 rounded-md mt-4 cursor-pointer"
				>
					Submit
				</button>
			</form>
		</div>

		<div>
			<p>Order status: <span id="orderStatus">None</span></p>
		</div>
	</body>
	<script>
		let stompClient = null;
		const usernameField = document.querySelector("#username");
		const productField = document.querySelector("#product");
		const quantityField = document.querySelector("#quantity");
		const orderStatus = document.querySelector("#orderStatus");
		const form = document.querySelector("#orderForm");
		const submitBtn = document.querySelector("#submitBtn");

		const submitForm = async (e) => {
			e.preventDefault();
			submitBtn.disabled = true;
			orderStatus.innerText = "Placing order";
			const username = usernameField.value;
			connectAndSubscribe(username);
			await sendOrderRequest();
			submitBtn.disabled = false;
		};

		const sendOrderRequest = async () => {
			const username = usernameField.value;
			const productName = productField.value;
			const quantity = quantityField.value;

			const payload = {
				username,
				productName,
				quantity,
			};

			// todo add api gateway to backend
			try {
				const response = await fetch("http://localhost:8083/orders", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload),
				});
				if (!response.ok) {
					throw new Error("response status: ", response.status);
				}
				const res = await response.json();
				orderStatus.innerText = "Order placed";
			} catch (err) {
				console.error(err);
			}
		};

		form.addEventListener("submit", submitForm);

		const connectAndSubscribe = (username) => {
			// check port
			const socket = new SockJS("http://localhost:8083/ws");
			stompClient = Stomp.over(socket);

			stompClient.connect({}, (frame) => {
				const subscriptionUrl = "/topic/order-status/" + username;

				stompClient.subscribe(subscriptionUrl, (message) => {
					const update = JSON.parse(message.body);
					console.log("received message", update);
					orderStatus.innerText = update.status;

					if (update.status == "COMPLETED" || update.status == "FAILED") {
						stompClient.disconnect(() => {
							console.log("disconnected");
						});
					}
				});
			});
		};
	</script>
</html>
